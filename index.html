<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام المحاسبة للشركات المقاولة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-background"></div>
        <div class="login-form-container">
            <div class="login-form neumorphic-card">
                <div class="logo-container">
                    <div class="brand">
                        <div class="brand-logo" aria-hidden="true">
                            <!-- Inline SVG simple logo placeholder -->
                            <svg class="logo-icon" width="56" height="56" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img">
                                <rect x="6" y="18" width="52" height="34" rx="4" fill="#2c5aa0"></rect>
                                <path d="M10 22h44v6H10z" fill="#fff" opacity="0.15"></path>
                                <path d="M20 10h24v8H20z" fill="#ffb02e"></path>
                                <g fill="#fff" font-size="10" font-family="sans-serif" transform="translate(8,28)">
                                </g>
                            </svg>
                        </div>
                        <div class="brand-text">
                            <div class="company-name">شركة المقاولات المتقدمة</div>
                            <h2 class="login-title">نظام المحاسبة</h2>
                            <p class="login-subtitle">للشركات المقاولة</p>
                        </div>
                    </div>
                </div>
                
                <form id="loginForm" class="mt-4" onsubmit="handleLogin(event)">
                    <div class="form-group mb-3">
                        <label for="username" class="form-label">اسم المستخدم</label>
                        <div class="input-container">
                            <i class="bi bi-person input-icon"></i>
                            <input type="text" class="form-control neumorphic-input" id="username" required>
                        </div>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="password" class="form-label">كلمة المرور</label>
                        <div class="input-container">
                            <i class="bi bi-lock input-icon"></i>
                            <input type="password" class="form-control neumorphic-input" id="password" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary neumorphic-btn w-100">
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        دخول
                    </button>
                </form>
                
                <div class="login-footer mt-4">
                    <p class="text-muted">نظام محاسبة متكامل يدعم الدولار الأمريكي والدينار العراقي</p>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>بيانات تسجيل الدخول الافتراضية:</strong><br>
                            اسم المستخدم: admin | كلمة المرور: admin123
                        </small>
                    </div>
                </div>
            </div>
                <!-- نافذة عند محاولة إغلاق المتصفح/التبويب (مستقلة) -->
                <div class="modal fade" id="browserExitModal" tabindex="-1" aria-labelledby="browserExitModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="browserExitModalLabel">تأكيد الخروج</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                            </div>
                             <div class="modal-body text-center">
                                 <h5 class="modal-title mb-2 text-dark">تأكيد الخروج</h5>
                                 <p id="logoutModalMsg" class="mb-0 text-dark">هل تود الخروج من البرنامج؟ اختر أحد الخيارات أدناه.</p>
                              </div>
                            <div class="modal-footer d-flex justify-content-between">
                                <button type="button" class="btn btn-primary" id="browserExportBtn">نعم مع تصدير البيانات</button>
                                <button type="button" class="btn btn-danger" id="browserYesBtn">نعم</button>
                                <button type="button" class="btn btn-secondary" id="browserCancelBtn" data-bs-dismiss="modal">كلا</button>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="dashboard-container" style="display: none;">
        <!-- Header -->
        <header class="dashboard-header neumorphic-card">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="header-info">
                            <div class="brand" style="align-items:center;">
                                <div class="brand-logo" aria-hidden="true">
                                    <!-- Inline SVG logo (same as login) -->
                                    <svg class="logo-icon" width="44" height="44" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img">
                                        <rect x="6" y="18" width="52" height="34" rx="4" fill="#2c5aa0"></rect>
                                        <path d="M10 22h44v6H10z" fill="#fff" opacity="0.15"></path>
                                        <path d="M20 10h24v8H20z" fill="#ffb02e"></path>
                                    </svg>
                                </div>
                                <div class="brand-text">
                                    <h1 class="dashboard-title">نظام المحاسبة</h1>
                                    <div class="program-name">نظام المحاسبة للشركات المقاولة</div>
                                    <div class="company-name small">شركة المقاولات المتقدمة</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-start">
                        <div class="header-actions">
                            <!-- سيتم إدراج زر الإعدادات أولاً برمجياً من settings.js عبر prepend -->
                            <label class="btn btn-outline-success neumorphic-btn ms-3" style="margin-bottom:0;">
                                <i class="bi bi-upload me-1"></i>
                                استيراد البيانات
                                <input type="file" id="importFileInput" style="display:none" accept="application/json" onchange="handleImportFile(event)">
                            </label>
                            <button class="btn btn-outline-primary neumorphic-btn ms-3" onclick="StorageManager.exportData()">
                                <i class="bi bi-download me-1"></i>
                                تصدير البيانات
                            </button>
                            <button class="btn btn-outline-danger neumorphic-btn ms-3" onclick="logout()" title="تبديل الحساب">
                                <i class="bi bi-box-arrow-right me-1"></i>
                                تبديل الحساب
                            </button>
                            <span class="user-welcome ms-3">مرحباً، <span id="currentUser">المدير</span></span>
                            <button class="btn btn-outline-warning neumorphic-btn ms-3" onclick="simulateBrowserExit()" title="إغلاق البرنامج">
                                <i class="bi bi-window-close me-1"></i>
                                إغلاق البرنامج
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Menu -->
        <nav class="main-navigation neumorphic-card">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <ul class="nav-menu">
                            <li class="nav-item">
                                <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                                    <i class="bi bi-speedometer2"></i>
                                    <span>لوحة التحكم</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" onclick="showSection('capital')">
                                    <i class="bi bi-cash-stack"></i>
                                    <span>رأس المال</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" onclick="showSection('expenses')">
                                    <i class="bi bi-receipt"></i>
                                    <span>المصروفات</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" onclick="showSection('reports')">
                                    <i class="bi bi-graph-up"></i>
                                    <span>التقارير</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" onclick="showSection('users')">
                                    <i class="bi bi-people"></i>
                                    <span>المستخدمون والصلاحيات</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="content-section">
                    <div class="row">
                        <!-- Statistics Cards -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stat-card neumorphic-card">
                                <div class="stat-icon usd-icon">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalUSD">$0.00</h3>
                                    <p>الصندوق - اجمالي الدولار امريكي</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stat-card neumorphic-card">
                                <div class="stat-icon iqd-icon">
                                    <i class="bi bi-cash"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalIQD">0 د.ع</h3>
                                    <p>الصندوق - اجمالي الدينار العراقي</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- بطاقة إجمالي الإيرادات (دينار) -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stat-card neumorphic-card">
                                <div class="stat-icon revenue-iqd-icon" style="background: linear-gradient(90deg,#ffb02e,#ff8a00);">
                                    <i class="bi bi-graph-up text-white"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalRevenueIQD">0 د.ع</h3>
                                    <p>إجمالي الإيرادات (د.ع)</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- بطاقة إجمالي المصروفات (دينار) -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stat-card neumorphic-card">
                                <div class="stat-icon expense-iqd-icon" style="background: linear-gradient(90deg,#ff6b6b,#ff3b3b);">
                                    <i class="bi bi-graph-down text-white"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalExpensesIQD">0 د.ع</h3>
                                    <p>إجمالي المصروفات (د.ع)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stat-card neumorphic-card">
                                <div class="stat-icon revenue-icon">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalRevenue">$0.00</h3>
                                    <p>إجمالي الايردات (دولار)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stat-card neumorphic-card">
                                <div class="stat-icon expense-icon">
                                    <i class="bi bi-graph-down-arrow"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalExpenses">$0.00</h3>
                                    <p>إجمالي المصروفات</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Transactions -->
                    <div class="row">
                        <div class="col-12">
                            <div class="neumorphic-card">
                                <div class="card-header">
                                    <h4><i class="bi bi-clock-history me-2"></i>آخر العمليات</h4>
                                </div>
                                <div class="card-body">
                                    <div id="recentTransactions" class="table-responsive">
                                        <!-- Recent transactions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Capital Section -->
                <div id="capitalSection" class="content-section" style="display: none;">
                    <!-- Capital content will be loaded here -->
                </div>

                <!-- Expenses Section -->
                <div id="expensesSection" class="content-section" style="display: none;">
                    <div id="expensesContent">
                        <!-- Expenses content will be loaded here -->
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-2">جاري تحميل قسم المصروفات...</p>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reportsSection" class="content-section" style="display: none;">
                    <!-- Reports content will be loaded here -->
                </div>

                <!-- Users Section -->
                <div id="usersSection" class="content-section" style="display: none;">
                    <!-- Users content will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth-fixed.js"></script>

         <!-- نافذة تأكيد الخروج -->
         <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
             <div class="modal-dialog modal-dialog-centered">
                 <div class="modal-content">
                     <div class="modal-header">
                         <h5 class="modal-title" id="logoutModalLabel">تأكيد الخروج</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                     </div>

                                    <div class="modal-body text-center">
                                        <h5 class="modal-title mb-2 text-dark">تأكيد الخروج</h5>
                                        <p id="browserExitMsg" class="mb-0 text-dark">هل تود الخروج من البرنامج؟ يمكنك اختيار تصدير البيانات قبل الخروج.</p>
                                    </div>
                     <div class="modal-footer d-flex justify-content-between">
                         <button type="button" class="btn btn-danger" id="confirmLogoutBtn">نعم</button>
                         <button type="button" class="btn btn-primary" id="exportLogoutBtn">نعم مع تصدير البيانات</button>
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">كلا</button>
                     </div>
                 </div>
             </div>
         </div>
    <script>
        // التحقق من جلسة المستخدم عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            if (window.SimpleAuthManager && SimpleAuthManager.checkSession()) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                document.getElementById('currentUser').textContent = SimpleAuthManager.getCurrentUser().name;
            }
        });

        // معالجة تسجيل الدخول
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const result = await SimpleAuthManager.login(username, password);
                
                if (result.success) {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainDashboard').style.display = 'block';
                    document.getElementById('currentUser').textContent = result.user.name;
                } else {
                    alert(result.message || 'اسم المستخدم أو كلمة المرور غير صحيحة');
                }
            } catch (error) {
                console.error('خطأ في تسجيل الدخول:', error);
                alert('حدث خطأ أثناء تسجيل الدخول: ' + error.message);
            }
        }

        // دالة تسجيل الخروج

           // دالة تسجيل الخروج مع نافذة تأكيد
           function logout() {
               var modal = new bootstrap.Modal(document.getElementById('logoutModal'));
               modal.show();
           }

           // تنفيذ الخروج فقط
           document.addEventListener('DOMContentLoaded', function() {
               document.getElementById('confirmLogoutBtn').onclick = function() {
                   SimpleAuthManager.logout();
                   document.getElementById('mainDashboard').style.display = 'none';
                   document.getElementById('loginPage').style.display = 'block';
                   document.getElementById('username').value = '';
                   document.getElementById('password').value = '';
                   bootstrap.Modal.getInstance(document.getElementById('logoutModal')).hide();
               };
               // تنفيذ الخروج مع تصدير البيانات
               document.getElementById('exportLogoutBtn').onclick = function() {
                   StorageManager.exportData();
                   SimpleAuthManager.logout();
                   document.getElementById('mainDashboard').style.display = 'none';
                   document.getElementById('loginPage').style.display = 'block';
                   document.getElementById('username').value = '';
                   document.getElementById('password').value = '';
                   bootstrap.Modal.getInstance(document.getElementById('logoutModal')).hide();
               };
           });

          // دالة لمحاكاة إغلاق المتصفح لاختبار النوافذ والخيارات دون إغلاق التبويب
          function simulateBrowserExit() {
              // نستخدم نفس مودال الخروج العادي لاختبار الخيارات
              const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
              modal.show();
          }

          // أفضل طريقة لتعطيل/عرض مربع تأكيد الإغلاق في معظم المتصفحات: ضبط window.onbeforeunload
          // Note: browsers may ignore custom messages and show a generic prompt, and some settings/extensions disable the prompt.
          window.onbeforeunload = function (e) {
              try {
                  console.log('onbeforeunload fired, _allowUnload=', window._allowUnload);
                  const main = document.getElementById('mainDashboard');
                  const mainVisible = main && window.getComputedStyle(main).display !== 'none';
                  console.log('mainVisible=', mainVisible);
                  if (!mainVisible) return undefined;
                  if (window._allowUnload) return undefined;
                  // Return a non-undefined value to trigger the browser's confirmation dialog
                  e = e || window.event;
                  const message = 'هل تود الخروج من البرنامج؟ سيتم فقدان التغييرات غير المحفوظة.';
                  // Some browsers ignore the returned string but require a non-undefined return value
                  if (e) e.returnValue = message;
                  return message;
              } catch (err) {
                  console.error('onbeforeunload handler error:', err);
                  return undefined;
              }
          };

          // إضافة زر اختبار بديل يستخدم confirm() لكي ترى فوراً مربع التأكيد (fallback)
          function testBeforeUnloadConfirm() {
              const main = document.getElementById('mainDashboard');
              const mainVisible = main && window.getComputedStyle(main).display !== 'none';
              console.log('testBeforeUnloadConfirm mainVisible=', mainVisible);
              if (!mainVisible) return alert('الرجاء تسجيل الدخول أولاً لعرض الاختبار');
              const ok = confirm('هل تود الخروج من البرنامج؟\nاختر نعم لتصدير أو خروج، لا لإلغاء.');
              console.log('confirm result=', ok);
          }

          // سجلات إضافية لمراقبة تغيّر الظهور وسلوك الصفحة
          document.addEventListener('visibilitychange', function() {
              console.log('visibilitychange, visibilityState=', document.visibilityState);
          });

           // دالة استيراد البيانات من ملف
           function handleImportFile(event) {
               const file = event.target.files[0];
               if (!file) return;
               StorageManager.importData(file)
                   .then(() => {
                       alert('تم استيراد البيانات بنجاح!');
                       location.reload();
                   })
                   .catch(err => {
                       alert('فشل الاستيراد: ' + err.message);
                   });
           }
    </script>
    <script src="js/dashboard.js"></script>
    <script src="js/capital.js"></script>
    <script src="js/expenses.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/app.js"></script>
    <script src="js/print-utils.js"></script>
    <script src="js/settings.js"></script>
</body>
</html>
